<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Preview Template | Critico</title>
<link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32.png">

<!-- Fonts -->
<link href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600,700' rel='stylesheet'>
<link href='//fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://use.fontawesome.com/5de09dda2d.css">

<!-- CSS -->
<link rel="stylesheet" href="../../css/app/app-main.css">
<link href="../../css/dashboard/style.css" rel="stylesheet">
<link href="../../css/dashboard/bootstrap.min.css" rel="stylesheet">
<link href="../../css/dashboard/bootstrap-theme.min.css" rel="stylesheet">
<link href="../../css/dashboard/bootstrapValidator.min.css" rel="stylesheet">
<link href="../../css/dashboard/critico-icons.css" rel="stylesheet">
<link href="../../css/dashboard/bootstrap-tagsinput.css" rel="stylesheet">
<link href='../../css/dashboard/redesign.css' rel='stylesheet'>
<link href='../../css/dashboard/left_nav.css' rel='stylesheet'>
<link href='../../css/dashboard/clients.css' rel='stylesheet'>
<link href='../../css/dashboard/welcome.css' rel='stylesheet'>
<link href='../../css/dashboard/dashboard.css' rel='stylesheet'>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Scripts -->
<script src="../../js/dashboard/Promise.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="../../js/dashboard/bootstrap.min.js"></script>
<script src="../../js/dashboard/bootstrapValidator.min.js"></script>
<script src="../../js/dashboard/jquery.history.js"></script>
<script src="../../js/dashboard/bootstrap-tagsinput.js"></script>
<script src="../../js/dashboard/bootstrap-contextmenu.js"></script>
<script src="../../js/dashboard/jquery.class.min.js"></script>
<script src="../../js/dashboard/config.min.js"></script>

<!--Optimizely-->
<script src="https://cdn.optimizely.com/js/230834568.js"></script>
<!--end Optimizely-->

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
<![endif]-->

<script src="assets/js/modernizr.min.js"></script>
<script src="https://use.fontawesome.com/03f81593ac.js"></script>
</head>

<style>

	body { 
		
		background-color: #FFF; 
	}
	
	#submit_template_bar { 
		background-color: #FFF; 
		position: absolute; 
		z-index: 99; 
		width: 100%; 
		box-shadow: inset 0px -1px 0px rgba(0,0,0,0.12); 
	}
	
	#preview { 
		height: 100%; 
		width: 100%; 
		box-sizing: border-box; 
		-moz-box-sizing: border-box; 
		overflow: auto; 
		background-color: #F7F7F7;
		padding: 50px 250px;
		border-top: 1px solid #E8E8E8;
	}
	
	#preview table { 
		margin: auto; 
		position: relative; 
	}
	
	.back { 
		position: absolute; 
		left: 25px; 
		top: 20px; 
		color: #828282; 
		box-shadow: 0px 0px 0px 1px rgba(0,0,0,0.25); 
		line-height: 45px!important; 
		height: 45px; 
		text-transform: uppercase; 
		font-size: 12px;

	}
	
	.back a { 
		color: #828282; 
		line-height: 46px; 
		display: block; 
		width: 100%; 
		height: 100%; 
	}
	
	.start { 
		position: absolute; 
		right: 15px; 
		top: 11px; 
		text-align: center;
	}
	
	.start a {
		border: 1px solid gray;
		display: inline-block;
    	background: #B0B0B0;
    	border: 0;
    	border-radius: 5px;
    	color: #fff;
    	line-height: 15px;
    	font-family: 'Open Sans', sans-serif;
    	font-weight: bold;
    	text-transform: uppercase;
    	cursor: pointer;
    	-webkit-transition: background .3s;
    	transition: background .3s;
    	font-size: .77778em;
    	padding: 10px 25px;
    	letter-spacing: .1em;
    	border-radius: .5em;
	}
	
	.start a:hover {
		text-decoration: none;
	}
	
	.start.active a {
		background-color: #ED9840; 
	}
	
	.back_btn { 
		position: absolute;
		top: 11px;
		left: 25px;
		border: 1px solid gray;
		display: inline-block;
    	background: #B0B0B0;
    	border: 0;
    	border-radius: 5px;
    	color: #fff;
    	line-height: 15px;
    	font-family: 'Open Sans', sans-serif;
    	font-weight: bold;
    	text-transform: uppercase;
    	cursor: pointer;
    	-webkit-transition: background .3s;
    	transition: background .3s;
    	font-size: .77778em;
    	padding: 10px 35px;
    	letter-spacing: .1em;
    	border-radius: .5em;
		
	}
	
	.back_btn:hover { 
		background: #A6A6A6; 
		
		
	}
	
	#not_compatible { 
		text-align: center; 
		width: 500px; 
		padding-top: 12%; 
		font-size: 16px; 
		line-height: 26px; 
		color: #787878; 
		margin: auto; 
		display: none; 
	}
	
	#not_compatible a { 
		color: #FFF; 
		text-transform: uppercase; 
		font-size: 13px; 
		display: block; 
		height: 55px; 
		line-height: 55px; 
		border-radius: 3px;
		width: 300px; 
		margin: auto; 
		margin-top: 40px;
	}
	
	#template-dump { 
		width: 680px; 
		height: 100%; 
		position: absolute; 
		left: 0; 
		top: 0; 
		z-index: -2; 
		visibility: collapse; 
	}
	
	.disable { 
		background-color: #bbbbbb !important; 
	}

</style>
<!-- Scripts -->
<script type="text/javascript" src="../../js/app/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../js/app/functions.js"></script>
<script>

$(document).ready(function() {

	name = "<%= name %>";

	if (name) {
		name = encodeURIComponent(name);
		$('#preview').load('../../pages/app/templates/emails/'+name+'.html', function() {
			headers();
			modules();
			$('.start').addClass('active');
		});
	}

	else {
		return false;
	}

	$(document).on('keypress', '#preview_temp_name', function(e){

		setTimeout(function(){
			val = $('#preview_temp_name').val();
			$('#name').val(val);

		}, 50);

	});

	$('#preview').on('click', 'a', function(e){
		e.preventDefault();
	});

	$(document).on('click', '.start.active:contains("Use Template")', function(){

		headline = 'What Should We Call It?';
		paragraph = 'Once created, you can manage your templates on the Saved Email Templates page.';

		btnTrue = 'Start editing';
		btnTrueId = 'edit_template';

		btnFalse = 'Cancel';
		btnFalseId = 'cancel_template'

		inputField = 'New Template Name';
		inputFieldId = 'preview_temp_name';

		if ($('[data-module]').length < 1) {
			btnTrue = 'Go to send page';
		}

		$('body').css('background-color','#ffffff');
		openPopup();
		setTimeout(function(){
			$('#popup').find('[type="text"]').attr('maxlength','30')
		}, 500)
	});

	$(document).on('click', '.back_btn', function(){
		$(location).attr('href','/app/new-email-template');
	})

	$(document).on('click', '#edit_template', function(){
		if( !$('#preview_temp_name').val() ) {
			notificationContent = 'Please insert a valid template name';
			notificationColor = '#ea5a5b';
			notification();
		}

		else {
			token = '';
			campaign_name = $('#preview_temp_name').val();
			//if token exists, copy campaign
			if(token){
				$(location).attr('href','../scripts/calls.php?func=create_campaign&token='+token+'&campaign_name='+campaign_name);
			}

			//if the template has the name parameter
			/* remove this for now to test */
			else if(!name == '' || via_import == 'true' || bycode == 'true'){

				$('#start_campaign').trigger('click');

			}

			//start editing
			else {

				if(prepareCampaignFlag){ return false; }
				prepareCampaignFlag = true;

				$('#edit_template').val('Preparing campaign..');
				$('#edit_template').addClass('disable');

				//variables
				img_array = [];

				//for each image
				$('#preview img').each(function(){

					//variables
					img_src = $(this).attr('src');

					//if the image contains stampready/dashboard/, than the images has already been uploaded to our server
					if (img_src.indexOf('stampready.net/dashboard/') >= 0){

					}

					//else, add it to the array to convert it later
					else {

						img_array.push(img_src);

					}

				});

				//count how many items the array hold
				array_count = img_array.length;

				//if the array has more than 0 items, make sure to convert them
				if(array_count > 0){

					captureCurrentDiv();

				}

				else {

					captureCurrentDiv();

				}

			}

		}


	});

	$(document).on('click', '#try_again', function(){

		$(location).attr('href', '../new_campaign/index.php');

	});

	$(document).on('click', '#close_popup', function(){

		closePopup();
		$('').css('overflow', 'scroll');

	});

	preview = $('#preview').html();

	if (preview.indexOf('<script') > -1) { $(location).attr('href','../new_campaign/index.php?action=invalid_file'); }

});


function headers() {

	//Reset vars
	meta = '';
	title = '';
	style = '';

	//Read and all meta tags
	$('#preview').find('meta').each(function(){

		meta += $(this).clone().wrap('<div>').parent().html();

	});

	//Read all title tags
	$('#preview').find('title').each(function(){

		title += $(this).clone().wrap('<div>').parent().html();

	});

	//Read all link tags
	$('#preview').find('link').each(function(){

		style += $(this).clone().wrap('<div>').parent().html();

	});

	//Read all style tags
	$('#preview').find('style').each(function(){

		style += $(this).clone().wrap('<div>').parent().html();

	});

	//Prepend style tag to canvas so responsiveness works
	$('#titles').val(title);
	$('#meta').val(meta);
	$('#styles').val(style);

}

function modules() {

	$('table[data-module]').each(function(){

		cur_val = $('#modules').val();
		module = $(this).clone().wrap('<div>').parent().html();

		$('#modules').val(cur_val+module);

	});

	if ($('[data-module]').length > 0) {

 	}

 	else {

 		source = $('#preview').html();

	 	$('.start a').text('Send Newsletter');
	 	$('#modules').val(source);
	 	$('#template').val(source);
	 	$('#nc').val('1');

	 	//check if process went successful
		setTimeout(function(){

	 		checkIfSuccessful();

		}, 500);

 	}

 	//fetch plain text
   $('#preview').find('td').each(function(){

		var el = $(this);

		if($(el).children('table').length) {}

		else {

			var text = $(el).text();
			var text = text.replace(/<br\/>/g, '').replace(/\n/g, '').replace(/	/g, '').replace(/  /g, '').replace(/VIEW ONLINE/g, '').replace(/view online/g, '');
			var count = text.split(' ').length;

			if($.trim($(el).html()) == '' || $.trim($(el).html()) == ' '){}

			else if($(el).is(':empty')) {}

			else if(count == 1){}

			else if(text == ' '){}

			else {

				plain_text = plain_text+text;
				plain_text = plain_text+'\r';

			}

		}

	});

	//dump in plain text
	$('#plain_text').val(plain_text);

}

function checkIfSuccessful() {

	previewHtml = $('#preview').html();
	page = $(location).attr('href');

	if (!previewHtml.trim()) {

		if (page.toLowerCase().indexOf("byurl") >= 0){

			headline = 'URL incorrect!';
			paragraph = 'It seems you\'ve tried to import a template via a URL, but it looks empty. Are you sure it\'s correct?';

		}

		else if (page.toLowerCase().indexOf("bycode") >= 0){

			headline = 'Woah! Nothing!';
			paragraph = 'It seems you\'ve tried to import HTML by code, but it looks empty. Are you sure it\'s correct?';

		}

		else {

			headline = 'Incorrect ZIP file!';
			paragraph = 'You\'ve uploaded an uncompatible zip file. This is an error by the creator of the template, not an error by StampReady. If you bought the template from a marketplace, make sure to unzip this first. There should be a standalone StampReady compatible zip file in there. <br/>If not, manually zip the StampReady folder and import that one.<br/><br/>Developers may visit the developer\'s guide <a href="../../developer/index.php" class="brandColor semi_bold">here</a>.';

		}

		btnTrue = 'Let\'s try again';
		btnTrueId = 'try_again';

		$('body').css('background-color','#757575');

		openPopup();

		$('.start').attr('class','start')

	}

	else if ($('[data-module]').length < 1) {

		headline = 'This template is not StampReady compatible';
		paragraph = 'You\'ll only be able to send your campaign. For more information regarding StampReady templates, you can visit our developer\'s guide over <a href="../../developer/index.php" class="brandColor semi_bold">here</a>.';

		btnTrue = 'I understand';
		btnTrueId = 'close_popup';

		$('body').css('background-color','#757575');

		openPopup();

	}

}

function captureCurrentDiv() {

	//variables
	newString = 'only screen and (max-width: 0px)';
	preview_html = $('#preview').html();
	preview_html = preview_html.replace(/@media.+?{/g,"@media "+newString+"{");

	css_template = $('#preview').find('style').each(function(){

		css = $(this).text();
		css = css.replace(/@media.+?{/g,"@media "+newString+"{");

		$(this).text(css);

	})

	//append invisible div
	$('#template-wrapper').prepend('<div id="template-dump">'+preview_html+'</div>');
	count = $('#template-dump [data-module]').size();

	for (i = 0; i < count; i++) {

	    $('#template-dump [data-module]').eq(8).remove();

	}

	template = $('#template-dump');

	setTimeout(function(){

		if ((navigator.appVersion.indexOf("Win")!=-1) || array_count > 0){

			//variables
			path = $(location).attr('href');

			//inject thumbnail path
			$('#thumbnail').val('none');

			//inject template path
			$('#path').val(path);

			$('#start_campaign').trigger('click');

		}
		else {

			html2canvas(template, {
				width: '680',
				height: '894',
				background:'#fff',
				onrendered: function(canvas)
				{
					var img = canvas.toDataURL()
					$.post("../scripts/calls.php?func=save_template_thumbnail", {data: img}, function (file) {

						//variables
						path = $(location).attr('href');

						//inject thumbnail path
						$('#thumbnail').val(file);

						//inject template path
						$('#path').val(path);

						$('#start_campaign').trigger('click');

					});
				}
			});

		}

	}, 1000)

}

</script>
<script>
	$(document).ready(function(){
    	$("#email-templates-link").addClass( "active" );
    });
    </script>
<body class="fixed-left">
    <div id="wrapper">
    	<div class="content-page">
    		<% include ../../partials/app/dashboard-navigation-main %>
            <div class="content">
                <div class="container-fluid">
                   	<div class="row">
						<div class="col-xl-12">
							<div class="page-title-box">
                                <div class="clearfix"></div>
                            </div>
						</div>
					</div>
                    <div class="row">
                    	<form action="/app/create/new-email-template" method="post" class="hidden" id="create_email_template">
							<input type="text" id="name" name="name">
							<input type="text" id="titles" name="titles">
							<input type="text" id="meta" name="meta">
							<input type="text" id="styles" name="styles">
							<input type="text" id="modules" name="modules">
							<input type="text" id="template" name="template">
							<input type="text" id="plain_text" name="plain_text">
							<input type="text" id="nc" name="nc">
							<input type="text" id="thumbnail" name="thumbnail">
							<input type="text" id="path" name="path">
							<input type="submit" value="go" id="start_campaign" name="create_campaign">
						</form>
						<div id="submit_template_bar">
							<div class="back_btn semi_bold">
								<span class="fa fa-chevron-circle-left" style="padding-right: 10px"></span>
								Back
							</div>
							<div class="start">
								<a href="#" class="semi_bold">Use Template<span class="fa fa-chevron-circle-right" id="inline-cta-icon" style="padding-left: 10px"></span></a>
							</div>
						</div>
						 <div id="preview">
						</div>
                    </div>
                </div>
            </div>
       	</div>
    </div>
    
</body>
</html>

